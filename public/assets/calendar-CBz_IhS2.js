import{f as p}from"./fetch-CZzGIe3w.js";import"./main-C1mOldaD.js";import{s as u,c as w}from"./toast-D7kci-jR.js";async function D(a,t,e){try{const n=localStorage.getItem("user_id"),o=localStorage.getItem("token"),[s,c,l,d]=await Promise.all([p(`/api/shifts/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${o}`}}),p(`/api/exercise/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${o}`}}),p(`/api/sickness/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${o}`}}),p(`/api/others/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${o}`}})]),r=[...s.map(i=>({id:`shift_${i.shift_id||i.id}`,title:"Työvuoro",start:`${i.start_date.slice(0,10)}T${i.start_time.slice(0,10)}`,end:`${i.end_date.slice(0,10)}T${i.end_time.slice(0,10)}`,className:["shift-event"],extendedProps:{type:"shift",_id:i.shift_id||i.id,is_night_shift:i.is_night_shift}})),...c.map(i=>({id:`ex_${i.Exercise_id}`,title:i.exercise_type,start:i.exercise_date.slice(0,10),className:["exercise-event"],extendedProps:{type:"exercise",level:i.level,notes:i.notes}})),...l.map(i=>({id:`sick_${i.Sickness_id}`,title:i.description,start:i.sickness_date.slice(0,10),className:["sickness-event"],extendedProps:{type:"sickness",impact:i.impact,notes:i.notes}})),...d.map(i=>({id:`other_${i.Others_id}`,title:i.description,start:i.others_date.slice(0,10),className:["others-event"],extendedProps:{type:"others",intensity:i.intensity,notes:i.notes}}))];t(r)}catch(n){if(console.error("Error fetching events:",n),n=="jwt expired"){localStorage.clear(),location.href="index.html";return}e(n)}}function M(a,t){const e=a.event,n=e.extendedProps;if(n.type==="shift")document.getElementById("editShiftModal").style.display="block",document.getElementById("editDate").value=e.startStr.split("T")[0],document.getElementById("editStartTime").value=e.startStr.split("T")[1].slice(0,5),document.getElementById("editEndTime").value=e.endStr.split("T")[1].slice(0,5),document.getElementById("eventId").value=n._id;else{const o=document.getElementById("editModal"),s=o.querySelector("#editEventForm"),c={exercise:"Muokkaa liikuntasuoritusta",sickness:"Muokkaa sairastumista",others:"Muokkaa muuta tapahtumaa"};switch(o.querySelector("h2").textContent=c[n.type]||"Muokkaa tapahtumaa",s.start_time.closest("label").style.display="none",s.end_time.closest("label").style.display="none",s.level.closest("label").style.display="none",n.type){case"exercise":s.start_time.closest("label").style.display="block",s.end_time.closest("label").style.display="block",s.level.closest("label").style.display="block";break;case"sickness":case"others":s.level.closest("label").style.display="block";break}s.event_id.value=e.id,s.event_type.value=n.type,s.date.value=e.startStr.split("T")[0],s.description.value=e.title,e.startStr.includes("T")&&(s.start_time.value=e.startStr.split("T")[1].slice(0,5)),e.endStr&&e.endStr.includes("T")&&(s.end_time.value=e.endStr.split("T")[1].slice(0,5)),s.level.value=n.level||n.impact||n.intensity||"",s.notes.value=n.notes||"",o.style.display="block"}}function b(a){document.getElementById("shiftForm").addEventListener("submit",async function(t){t.preventDefault(),await F(a)}),document.getElementById("exerciseForm").addEventListener("submit",async function(t){t.preventDefault(),await E("exerciseForm","exercise","/api/exercise",a)}),document.getElementById("sicknessForm").addEventListener("submit",async function(t){t.preventDefault(),await E("sicknessForm","sickness","/api/sickness",a)}),document.getElementById("othersForm").addEventListener("submit",async function(t){t.preventDefault(),await E("othersForm","others","/api/others",a)}),document.getElementById("editShiftForm").addEventListener("submit",async function(t){t.preventDefault(),await L(a)}),document.getElementById("deleteShiftButton").addEventListener("click",async function(){await C(a)}),document.getElementById("editEventForm").addEventListener("submit",async function(t){t.preventDefault(),await j(a)}),document.getElementById("deleteEventButton").addEventListener("click",async function(){await O(a)})}async function F(a){const t=a.getDate(),e=t.getFullYear(),n=t.getMonth(),o=new Date(e,n+1,0).getDate(),s=localStorage.getItem("user_id"),c=localStorage.getItem("token");let l=0;const d=[];for(let r=1;r<=o;r++){const i=document.querySelector(`[name="start_${r}"]`),m=document.querySelector(`[name="end_${r}"]`);if(i&&m&&i.value&&m.value)try{const h=i.value,v=m.value,f=new Date(e,n,r);let y=new Date(e,n,r);const[S,I]=h.split(":").map(Number),[k,_]=v.split(":").map(Number);f.setHours(S,I),y.setHours(k,_);const $=y<f;$&&y.setDate(y.getDate()+1);const T=f.toISOString().split("T")[0],B=y.toISOString().split("T")[0],x={user_id:parseInt(s),start_date:T,start_time:`${String(S).padStart(2,"0")}:${String(I).padStart(2,"0")}:00`,end_date:B,end_time:`${String(k).padStart(2,"0")}:${String(_).padStart(2,"0")}:00`,is_night_shift:$},g=await fetch("/api/shifts",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${c}`},body:JSON.stringify(x)});if(!g.ok){if(g.status==403){localStorage.clear(),location.href="index.html";return}throw new Error(`HTTP error! status: ${g.status}`)}l++}catch(h){console.error(`Tallennusvirhe päivälle ${r}.${n+1}:`,h),d.push(`Päivä ${r}.${n+1}. ei tallentunut: ${h.message}`)}}d.length>0?u(`Virheitä tallennuksessa: ${d.join(", ")}`):l>0?(u(`Tallennettu ${l} työvuoro(a)`),a.refetchEvents()):u("Ei tallennettuja työvuoroja"),closeModal("shiftModal")}async function E(a,t,e,n){const o=document.getElementById(a),s=new FormData(o),c={};s.forEach((l,d)=>{c[d]=l}),c.user_id=localStorage.getItem("user_id");try{const d={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(c)},r=await p(e,d);if(r.error){if(r.error=="jwt expired"){localStorage.clear(),location.href="index.html";return}throw new Error(r.error)}u(`${t.charAt(0).toUpperCase()+t.slice(1)} tallennettu!`),closeModal(`${t}Modal`),n.refetchEvents()}catch(l){if(l=="jwt expired"){localStorage.clear(),location.href="index.html";return}console.error(`Error saving ${t}:`,l),u(`Virhe tallennettaessa ${t}: ${l.message}`)}}async function L(a){const t=document.getElementById("eventId").value,e=document.getElementById("editDate").value,n=document.getElementById("editStartTime").value,o=document.getElementById("editEndTime").value;try{const s=localStorage.getItem("token"),c=localStorage.getItem("user_id"),l=new Date(`${e}T${n}`),r=new Date(`${e}T${o}`)<l;let i=e;if(r){const f=new Date(l);f.setDate(f.getDate()+1),i=f.toISOString().split("T")[0]}const m={user_id:c,start_date:e,start_time:n+":00",end_date:i,end_time:o+":00",is_night_shift:r},h=await p(`/api/shifts/${t}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify(m)});if(h.error=="jwt expired"){localStorage.clear(),location.href="index.html";return}if(h.error)throw new Error(h.error);const v=a.getEventById(`shift_${t}`);v&&v.setDates(`${m.start_date}T${m.start_time}`,`${m.end_date}T${m.end_time}`),u("Työvuoro päivitetty!"),closeModal("editShiftModal")}catch(s){if(s=="jwt expired"){localStorage.clear(),location.href="index.html";return}console.error("Virhe työvuoron päivityksessä:",s),u("Virhe päivitettäessä työvuoroa: "+s.message)}}async function C(a){if(!await w("Haluatko varmasti poistaa tämän työvuoron?"))return;const e=document.getElementById("eventId").value;try{const n=localStorage.getItem("token"),o=await p(`/api/shifts/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${n}`}});if(o.error=="jwt expired"){localStorage.clear(),location.href="index.html";return}if(o.error)throw new Error(o.error);const s=a.getEventById(`shift_${e}`);s&&s.remove(),u("Työvuoro poistettu!"),closeModal("editShiftModal")}catch(n){console.error("Virhe työvuoron poistossa:",n),u("Virhe poistettaessa työvuoroa: "+n.message)}}async function j(a){const t=localStorage.getItem("user_id"),e=document.getElementById("editEventForm"),n=e.event_id.value,o=e.event_type.value,s=n.split("_")[1];if(!s){u("Tapahtuman ID on puutteellinen!");return}const c={exercise:`/api/exercise/${s}`,sickness:`/api/sickness/${s}`,others:`/api/others/${s}`};let l={};o==="exercise"?l={user_id:t,[`${o}_date`]:e.date.value,exercise_type:e.description.value,start_time:e.start_time.value,end_time:e.end_time.value,level:e.level.value,notes:e.notes.value}:o==="sickness"?l={user_id:t,[`${o}_date`]:e.date.value,description:e.description.value,impact:e.level.value,notes:e.notes.value}:o==="others"&&(l={user_id:t,[`${o}_date`]:e.date.value,description:e.description.value,intensity:e.level.value,notes:e.notes.value});try{const r={method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(l)},i=await p(c[o],r);if(i.error)throw new Error(i.error);u("Tapahtuma päivitetty!"),closeModal("editModal"),a.refetchEvents()}catch(d){if(d=="jwt expired"){localStorage.clear(),location.href="index.html";return}u("Virhe päivitettäessä tapahtumaa: "+d.message)}}async function O(a){const t=document.getElementById("editEventForm"),e=t.event_id.value,n=t.event_type.value,o=e.split("_")[1];if(!o){u("Tapahtuman ID on puutteellinen!");return}const s={exercise:`/api/exercise/${o}`,sickness:`/api/sickness/${o}`,others:`/api/others/${o}`};if(await w("Haluatko varmasti poistaa tapahtuman kalenterista?"))try{const d={method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}},r=await p(s[n],d);if(r.error=="jwt expired"){localStorage.clear(),location.href="index.html";return}if(r.error)throw new Error(r.error);u("Tapahtuma poistettu!"),closeModal("editModal"),a.refetchEvents()}catch(l){u("Virhe poistettaessa tapahtumaa: "+l.message)}}function P(a){document.getElementById("openShiftModal").addEventListener("click",()=>{z(a),document.getElementById("shiftModal").style.display="block"}),document.getElementById("openExerciseModal").addEventListener("click",()=>{document.getElementById("exerciseModal").style.display="block"}),document.getElementById("openSicknessModal").addEventListener("click",()=>{document.getElementById("sicknessModal").style.display="block"}),document.getElementById("openOthersModal").addEventListener("click",()=>{document.getElementById("othersModal").style.display="block"}),window.closeModal=function(t){document.getElementById(t).style.display="none",document.getElementById("shiftForm").reset(),document.getElementById("exerciseForm").reset(),document.getElementById("sicknessForm").reset(),document.getElementById("othersForm").reset(),document.getElementById("editShiftForm").reset(),document.getElementById("editEventForm").reset()}}function z(a){const t=a.getDate(),e=t.getFullYear(),n=t.getMonth(),o=document.querySelector(".form-shift-table"),s=new Date(e,n+1,0).getDate();o.innerHTML='<div class="form-shift-header"><span>Aloitus aika:</span><span>Lopetus aika:</span></div>';for(let c=1;c<=s;c++){const d=new Date(e,n,c).toLocaleDateString("fi-FI",{weekday:"short"}),r=document.createElement("div");r.className="form-row",r.innerHTML=`
      <label>${d} ${c}.${n+1}.</label>
      <input type="time" name="start_${c}">
      <span>-</span>
      <input type="time" name="end_${c}">
    `,o.appendChild(r)}}function N(){document.querySelector("#event-instructions").addEventListener("click",A)}function A(a){a.preventDefault();const t=document.querySelector(".calendar-info"),e=document.querySelector("#event-instructions");t.style.display==="flex"?(t.style.animation="disappear 1s ease-out forwards",e.textContent="Lisätietoa tapahtumien tallennuksesta",setTimeout(()=>{t.style.display="none"},1e3)):(t.style.display="flex",t.style.animation="appear 1s ease-out forwards",e.textContent="Piilota lisätiedot",t.scrollIntoView({behavior:"smooth"}))}document.addEventListener("DOMContentLoaded",function(){const a=document.getElementById("calendarView"),t=new FullCalendar.Calendar(a,{initialView:"dayGridMonth",timeZone:"local",locale:"fi",firstDay:1,headerToolbar:{left:"prev",center:"title",right:"next"},titleFormat:{year:"numeric",month:"long"},eventClassNames:function(e){return e.event.extendedProps.type+"-event"},events:async function(e,n,o){await D(e,n,o)},eventMouseEnter:function(e){e.el.style.cursor="pointer",e.el.title="Klikkaa muokataksesi"},eventClick:function(e){M(e)},eventContent:H});t.render(),t.refetchEvents(),b(t),P(t),N()});function H(a){const{event:t}=a,e=t.extendedProps;if(e.type==="shift"){const o=t.start?t.start.toLocaleTimeString("fi-FI",{hour:"2-digit",minute:"2-digit"}):"",s=t.end?t.end.toLocaleTimeString("fi-FI",{hour:"2-digit",minute:"2-digit"}):"",c=parseInt(o.slice(0,2)),l=parseInt(s.slice(0,2));return c-l>=0?{html:`
          <div class="custom-shift-event" id="night-shift">
            <div class="shift-time">🌙 ${o} - ${s}</div>
          </div>
        `}:{html:`
          <div class="custom-shift-event">
            <div class="shift-time">☀️ ${o} - ${s}</div>
          </div>
        `}}return{html:`
      <div class="event-container">
        <span class="event-icon">${{exercise:"🏋️",sickness:"🤒",others:"📌"}[e.type]||"❔"}</span>
        <span class="event-text">${t.title}</span>
      </div>
    `}}
