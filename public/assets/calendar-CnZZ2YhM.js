import"./modulepreload-polyfill-B5Qt9EMX.js";import"./main-DGSle_11.js";import{f as m}from"./fetch-DBomrZ5j.js";function v(a){const t=document.createElement("div");t.className="toast",t.textContent=a,document.body.appendChild(t),setTimeout(()=>{t.remove()},3e3)}async function D(a,t,e){try{const n=localStorage.getItem("user_id"),s=localStorage.getItem("token"),[o,r,l,d]=await Promise.all([m(`/api/shifts/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${s}`}}),m(`/api/exercise/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${s}`}}),m(`/api/sickness/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${s}`}}),m(`/api/others/user/${n}`,{method:"GET",headers:{Authorization:`Bearer ${s}`}})]),c=[...o.map(i=>({id:`shift_${i.shift_id||i.id}`,title:"Työvuoro",start:`${i.start_date.slice(0,10)}T${i.start_time.slice(0,10)}`,end:`${i.end_date.slice(0,10)}T${i.end_time.slice(0,10)}`,className:["shift-event"],extendedProps:{type:"shift",_id:i.shift_id||i.id,is_night_shift:i.is_night_shift}})),...r.map(i=>({id:`ex_${i.Exercise_id}`,title:i.exercise_type,start:i.exercise_date.slice(0,10),className:["exercise-event"],extendedProps:{type:"exercise",level:i.level,notes:i.notes}})),...l.map(i=>({id:`sick_${i.Sickness_id}`,title:i.description,start:i.sickness_date.slice(0,10),className:["sickness-event"],extendedProps:{type:"sickness",impact:i.impact,notes:i.notes}})),...d.map(i=>({id:`other_${i.Others_id}`,title:i.description,start:i.others_date.slice(0,10),className:["others-event"],extendedProps:{type:"others",intensity:i.intensity,notes:i.notes}}))];console.log(c),t(c)}catch(n){if(console.error("Error fetching events:",n),n=="jwt expired"){localStorage.clear(),location.href="index.html";return}e(n)}}function B(a,t){const e=a.event,n=e.extendedProps;if(n.type==="shift")document.getElementById("editShiftModal").style.display="block",document.getElementById("editDate").value=e.startStr.split("T")[0],document.getElementById("editStartTime").value=e.startStr.split("T")[1].slice(0,5),document.getElementById("editEndTime").value=e.endStr.split("T")[1].slice(0,5),document.getElementById("eventId").value=n._id;else{const s=document.getElementById("editModal"),o=s.querySelector("#editEventForm"),r={exercise:"Muokkaa liikuntasuoritusta",sickness:"Muokkaa sairastumista",others:"Muokkaa muuta tapahtumaa"};switch(s.querySelector("h2").textContent=r[n.type]||"Muokkaa tapahtumaa",o.start_time.closest("label").style.display="none",o.end_time.closest("label").style.display="none",o.level.closest("label").style.display="none",n.type){case"exercise":o.start_time.closest("label").style.display="block",o.end_time.closest("label").style.display="block",o.level.closest("label").style.display="block";break;case"sickness":case"others":o.level.closest("label").style.display="block";break}o.event_id.value=e.id,o.event_type.value=n.type,o.date.value=e.startStr.split("T")[0],o.description.value=e.title,e.startStr.includes("T")&&(o.start_time.value=e.startStr.split("T")[1].slice(0,5)),e.endStr&&e.endStr.includes("T")&&(o.end_time.value=e.endStr.split("T")[1].slice(0,5)),o.level.value=n.level||n.impact||n.intensity||"",o.notes.value=n.notes||"",s.style.display="block"}}function M(a){document.getElementById("shiftForm").addEventListener("submit",async function(t){t.preventDefault(),await b(a)}),document.getElementById("exerciseForm").addEventListener("submit",async function(t){t.preventDefault(),await E("exerciseForm","exercise","/api/exercise",a)}),document.getElementById("sicknessForm").addEventListener("submit",async function(t){t.preventDefault(),await E("sicknessForm","sickness","/api/sickness",a)}),document.getElementById("othersForm").addEventListener("submit",async function(t){t.preventDefault(),await E("othersForm","others","/api/others",a)}),document.getElementById("editShiftForm").addEventListener("submit",async function(t){t.preventDefault(),await F(a)}),document.getElementById("deleteShiftButton").addEventListener("click",async function(){await L(a)}),document.getElementById("editEventForm").addEventListener("submit",async function(t){t.preventDefault(),await C(a)}),document.getElementById("deleteEventButton").addEventListener("click",async function(){await j(a)})}async function b(a){const t=a.getDate(),e=t.getFullYear(),n=t.getMonth(),s=new Date(e,n+1,0).getDate(),o=localStorage.getItem("user_id"),r=localStorage.getItem("token");let l=0;const d=[];for(let c=1;c<=s;c++){const i=document.querySelector(`[name="start_${c}"]`),u=document.querySelector(`[name="end_${c}"]`);if(i&&u&&i.value&&u.value)try{const p=i.value,y=u.value,h=new Date(e,n,c);let f=new Date(e,n,c);const[S,k]=p.split(":").map(Number),[_,I]=y.split(":").map(Number);h.setHours(S,k),f.setHours(_,I);const $=f<h;$&&f.setDate(f.getDate()+1);const T=h.toISOString().split("T")[0],w=f.toISOString().split("T")[0],x={user_id:parseInt(o),start_date:T,start_time:`${String(S).padStart(2,"0")}:${String(k).padStart(2,"0")}:00`,end_date:w,end_time:`${String(_).padStart(2,"0")}:${String(I).padStart(2,"0")}:00`,is_night_shift:$},g=await fetch("/api/shifts",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify(x)});if(!g.ok){if(g.status==403){localStorage.clear(),location.href="index.html";return}throw new Error(`HTTP error! status: ${g.status}`)}l++}catch(p){console.error(`Tallennusvirhe päivälle ${c}.${n+1}:`,p),d.push(`Päivä ${c}.${n+1}. ei tallentunut: ${p.message}`)}}d.length>0?v(`Virheitä tallennuksessa: ${d.join(", ")}`):l>0?(v(`Tallennettu ${l} työvuoro(a)`),a.refetchEvents()):v("Ei tallennettuja työvuoroja"),closeModal("shiftModal")}async function E(a,t,e,n){const s=document.getElementById(a),o=new FormData(s),r={};o.forEach((l,d)=>{r[d]=l}),r.user_id=localStorage.getItem("user_id");try{const d={method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(r)},c=await m(e,d);if(c.error){if(c.error=="jwt expired"){localStorage.clear(),location.href="index.html";return}throw new Error(c.error)}alert(`${t.charAt(0).toUpperCase()+t.slice(1)} tallennettu!`),closeModal(`${t}Modal`),n.refetchEvents()}catch(l){if(l=="jwt expired"){localStorage.clear(),location.href="index.html";return}console.error(`Error saving ${t}:`,l),alert(`Virhe tallennettaessa ${t}: ${l.message}`)}}async function F(a){const t=document.getElementById("eventId").value,e=document.getElementById("editDate").value,n=document.getElementById("editStartTime").value,s=document.getElementById("editEndTime").value;try{const o=localStorage.getItem("token"),r=localStorage.getItem("user_id"),l=new Date(`${e}T${n}`),c=new Date(`${e}T${s}`)<l;let i=e;if(c){const h=new Date(l);h.setDate(h.getDate()+1),i=h.toISOString().split("T")[0]}const u={user_id:r,start_date:e,start_time:n+":00",end_date:i,end_time:s+":00",is_night_shift:c},p=await m(`/api/shifts/${t}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(u)});if(p.error=="jwt expired"){localStorage.clear(),location.href="index.html";return}if(p.error)throw new Error(p.error);const y=a.getEventById(`shift_${t}`);y&&y.setDates(`${u.start_date}T${u.start_time}`,`${u.end_date}T${u.end_time}`),v("Työvuoro päivitetty!"),closeModal("editShiftModal")}catch(o){if(o=="jwt expired"){localStorage.clear(),location.href="index.html";return}console.error("Virhe työvuoron päivityksessä:",o),v("Virhe päivitettäessä työvuoroa: "+o.message)}}async function L(a){if(!confirm("Haluatko varmasti poistaa tämän työvuoron?"))return;const t=document.getElementById("eventId").value;try{const e=localStorage.getItem("token"),n=await m(`/api/shifts/${t}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}});if(n.error=="jwt expired"){localStorage.clear(),location.href="index.html";return}if(n.error)throw new Error(n.error);const s=a.getEventById(`shift_${t}`);s&&s.remove(),v("Työvuoro poistettu!"),closeModal("editShiftModal")}catch(e){console.error("Virhe työvuoron poistossa:",e),v("Virhe poistettaessa työvuoroa: "+e.message)}}async function C(a){const t=localStorage.getItem("user_id"),e=document.getElementById("editEventForm"),n=e.event_id.value,s=e.event_type.value,o=n.split("_")[1];if(!o){alert("Tapahtuman ID on puutteellinen!");return}const r={exercise:`/api/exercise/${o}`,sickness:`/api/sickness/${o}`,others:`/api/others/${o}`};let l={};s==="exercise"?l={user_id:t,[`${s}_date`]:e.date.value,exercise_type:e.description.value,start_time:e.start_time.value,end_time:e.end_time.value,level:e.level.value,notes:e.notes.value}:s==="sickness"?l={user_id:t,[`${s}_date`]:e.date.value,description:e.description.value,impact:e.level.value,notes:e.notes.value}:s==="others"&&(l={user_id:t,[`${s}_date`]:e.date.value,description:e.description.value,intensity:e.level.value,notes:e.notes.value});try{const c={method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(l)},i=await m(r[s],c);if(i.error)throw new Error(i.error);alert("Tapahtuma päivitetty!"),closeModal("editModal"),a.refetchEvents()}catch(d){if(d=="jwt expired"){localStorage.clear(),location.href="index.html";return}alert("Virhe päivitettäessä tapahtumaa: "+d.message)}}async function j(a){const t=document.getElementById("editEventForm"),e=t.event_id.value,n=t.event_type.value,s=e.split("_")[1];if(!s){alert("Tapahtuman ID on puutteellinen!");return}const o={exercise:`/api/exercise/${s}`,sickness:`/api/sickness/${s}`,others:`/api/others/${s}`};if(confirm("Haluatko varmasti poistaa tämän tapahtuman?"))try{const l={method:"DELETE",headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}},d=await m(o[n],l);if(d.error=="jwt expired"){localStorage.clear(),location.href="index.html";return}if(d.error)throw new Error(d.error);alert("Tapahtuma poistettu!"),closeModal("editModal"),a.refetchEvents()}catch(r){alert("Virhe poistettaessa tapahtumaa: "+r.message)}}function N(a){document.getElementById("openShiftModal").addEventListener("click",()=>{O(a),document.getElementById("shiftModal").style.display="block"}),document.getElementById("openExerciseModal").addEventListener("click",()=>{document.getElementById("exerciseModal").style.display="block"}),document.getElementById("openSicknessModal").addEventListener("click",()=>{document.getElementById("sicknessModal").style.display="block"}),document.getElementById("openOthersModal").addEventListener("click",()=>{document.getElementById("othersModal").style.display="block"}),window.closeModal=function(t){document.getElementById(t).style.display="none"}}function O(a){const t=a.getDate(),e=t.getFullYear(),n=t.getMonth(),s=document.querySelector(".form-shift-table"),o=new Date(e,n+1,0).getDate();s.innerHTML='<div class="form-shift-header"><span>Aloitus aika:</span><span>Lopetus aika:</span></div>';for(let r=1;r<=o;r++){const d=new Date(e,n,r).toLocaleDateString("fi-FI",{weekday:"short"}),c=document.createElement("div");c.className="form-row",c.innerHTML=`
      <label>${d} ${r}.${n+1}.</label>
      <input type="time" name="start_${r}">
      <span>-</span>
      <input type="time" name="end_${r}">
    `,s.appendChild(c)}}function P(){document.querySelector("#event-instructions").addEventListener("click",z)}function z(a){a.preventDefault();const t=document.querySelector(".calendar-info"),e=document.querySelector("#event-instructions");t.style.display==="flex"?(t.style.animation="disappear 1s ease-out forwards",e.textContent="Lisätietoa tapahtumien tallennuksesta",setTimeout(()=>{t.style.display="none"},1e3)):(t.style.display="flex",t.style.animation="appear 1s ease-out forwards",e.textContent="Piilota lisätiedot",t.scrollIntoView({behavior:"smooth"}))}document.addEventListener("DOMContentLoaded",function(){const a=document.getElementById("calendarView"),t=new FullCalendar.Calendar(a,{initialView:"dayGridMonth",timeZone:"local",locale:"fi",firstDay:1,headerToolbar:{left:"prev",center:"title",right:"next"},titleFormat:{year:"numeric",month:"long"},eventClassNames:function(e){return e.event.extendedProps.type+"-event"},events:async function(e,n,s){await D(e,n,s)},eventMouseEnter:function(e){e.el.style.cursor="pointer",e.el.title="Klikkaa muokataksesi"},eventClick:function(e){B(e)},eventContent:A});t.render(),t.refetchEvents(),M(t),N(t),P()});function A(a){const{event:t}=a,e=t.extendedProps;if(e.type==="shift"){const s=t.start?t.start.toLocaleTimeString("fi-FI",{hour:"2-digit",minute:"2-digit"}):"",o=t.end?t.end.toLocaleTimeString("fi-FI",{hour:"2-digit",minute:"2-digit"}):"",r=parseInt(s.slice(0,2)),l=parseInt(o.slice(0,2)),d=r-l;return console.log(r+" "+l),d>=0?{html:`
          <div class="custom-shift-event" id="night-shift">
            <div class="shift-time">🌙 ${s} - ${o}</div>
          </div>
        `}:{html:`
          <div class="custom-shift-event">
            <div class="shift-time">☀️ ${s} - ${o}</div>
          </div>
        `}}return{html:`
      <div class="event-container">
        <span class="event-icon">${{exercise:"🏋️",sickness:"🤒",others:"📌"}[e.type]||"❔"}</span>
        <span class="event-text">${t.title}</span>
      </div>
    `}}
